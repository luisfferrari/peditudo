name: iOS TestFlight

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.3
          channel: stable

      - run: flutter pub get

      - name: Install Fastlane
        run: sudo gem install fastlane

      - name: Build and Upload
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          mkdir -p ios/fastlane
          cat > ios/fastlane/Fastfile <<EOF
          default_platform(:ios)

          platform :ios do
            lane :beta do
              app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_content: ENV["APP_STORE_CONNECT_API_KEY"]
              )

              match(type: "appstore", readonly: false)

              build_app(
                workspace: "Runner.xcworkspace",
                scheme: "Runner",
                export_method: "app-store"
              )

              upload_to_testflight
            end
          end
          EOF

          cd ios
          fastlane beta
